(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class k{constructor(){this.canvas=null,this.isVisible=!1,this.isRunning=!1,this.targetPosition={x:0,y:0},this.targetSize={width:100,height:100},this.frames=[],this.currentFrame=0,this.frameCount=0,this.fps=8,this.lastFrameTime=0,this.isLoaded=!1,this.ctx=null,this.animationId=null,this.cachedSizes=new Map,console.log("AR动画类初始化完成")}start(t,e,s){t&&(console.log("启动AR动画..."),this.canvas=t,this.ctx=t.getContext("2d"),this.targetPosition=e||{x:0,y:0},this.targetSize=s||{width:100,height:100},this.isRunning||(this.isRunning=!0,this.isVisible=!0,this.lastFrameTime=performance.now(),this.animate()),console.log("AR动画已启动"))}stop(){console.log("停止AR动画..."),this.isRunning=!1,this.isVisible=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),console.log("AR动画已停止")}animate(){if(!this.isRunning||!this.ctx||!this.canvas)return;const t=performance.now();t-this.lastFrameTime>=1e3/this.fps&&(this.currentFrame=(this.currentFrame+1)%this.frameCount,this.lastFrameTime=t),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCurrentFrame(),this.animationId=requestAnimationFrame(()=>this.animate())}drawCurrentFrame(){if(!this.isLoaded||this.frames.length===0){console.log("动画未加载完成，跳过绘制",{isLoaded:this.isLoaded,framesCount:this.frames.length,currentFrame:this.currentFrame});return}const t=this.frames[this.currentFrame];if(!t){console.log("当前帧不存在",{currentFrame:this.currentFrame,totalFrames:this.frameCount});return}const e=this.getCachedDrawInfo(t);this.ctx.drawImage(t,e.x,e.y,e.width,e.height),this.currentFrame%10===0&&console.log("绘制动画帧",{frame:this.currentFrame,position:e,frameSize:`${t.width}x${t.height}`})}getCachedDrawInfo(t){const e=`${t.width}-${t.height}-${this.targetSize.width}-${this.targetSize.height}`;if(this.cachedSizes.has(e))return this.cachedSizes.get(e);const s=this.targetPosition.x,i=this.targetPosition.y,n=120,o=Math.max(this.targetSize.width,this.targetSize.height),a=Math.max(n,o*1),c=t.width,h=t.height,r=Math.min(a/c,a/h),l=c*r,d=h*r,m=s-l/2,w=i-d/2,p=window.innerWidth,u=window.innerHeight;let g=Math.max(10,Math.min(m,p-l-10)),f=Math.max(10,Math.min(w,u-d-10));const y={x:g,y:f,width:l,height:d};return this.cachedSizes.set(e,y),y}loadFrames(){return new Promise((t,e)=>{const s=["/images/GIF1.png","/images/GIF2.png","/images/GIF3.png","/images/GIF4.png"];let i=0,n=0;const o=s.length,a=setTimeout(()=>{i<o&&e(new Error("动画加载超时"))},3e3);s.forEach((c,h)=>{const r=new Image,l=setTimeout(()=>{n++,console.warn(`帧${h+1}加载超时: ${c}`),n===o&&(clearTimeout(a),e(new Error("所有帧加载失败")))},2e3);r.onload=()=>{clearTimeout(l),this.frames[h]=r,i++,console.log(`帧${h+1}加载成功: ${c}, 尺寸: ${r.width}x${r.height}`),i===o&&(clearTimeout(a),this.frameCount=o,this.isLoaded=!0,console.log(`所有帧加载完成，共${o}帧`),t())},r.onerror=d=>{clearTimeout(l),n++,console.error(`帧${h+1}加载失败:`,d),n===o&&(clearTimeout(a),e(new Error("所有帧加载失败")))},r.crossOrigin="anonymous",r.src=c})})}loadGif(t){return console.log("检测到GIF路径，自动切换到PNG逐帧动画模式"),this.loadFrames()}init(){console.log("AR动画初始化完成")}showAnimation(t,e){this.start(null,t,e)}hideAnimation(){this.stop()}update(){}dispose(){this.stop(),this.frames=[],this.isLoaded=!1,this.cachedSizes.clear(),console.log("AR动画资源已清理")}}class A{constructor(){this.lastDetection=null,this.detectionTimeout=500,this.templates=[],this.threshold=.15,this.debugMode=!1,this.lastDetectionTime=0,this.detectionInterval=250,this.isInitialized=!1,this.detectionCache=new Map,this.cacheTimeout=1e3,setTimeout(()=>{this.isInitialized=!0,console.log("图片追踪器延迟初始化完成")},200)}addTemplate(t,e="template"){return new Promise((s,i)=>{const n=new Image;n.crossOrigin="anonymous";const o=setTimeout(()=>{i(new Error("图片加载超时"))},2e3);n.onload=()=>{clearTimeout(o);const a=document.createElement("canvas"),c=a.getContext("2d"),h=150,r=Math.min(h/n.width,h/n.height,1);a.width=n.width*r,a.height=n.height*r,c.drawImage(n,0,0,a.width,a.height);const l=c.getImageData(0,0,a.width,a.height);this.templates.push({name:e,imageData:l,width:a.width,height:a.height}),console.log(`模板图片 "${e}" 添加成功，尺寸: ${a.width}x${a.height}`),s()},n.onerror=a=>{clearTimeout(o),console.error(`模板图片 "${e}" 加载失败:`,a),i(a)},n.src=t})}async detect(t,e,s){try{const i=Date.now();if(i-this.lastDetectionTime<this.detectionInterval)return this.lastDetection?this.lastDetection.result:{detected:!1};this.lastDetectionTime=i;const n=`${e}x${s}`,o=this.detectionCache.get(n);if(o&&i-o.timestamp<this.cacheTimeout)return o.result;if(this.lastDetection&&i-this.lastDetection.timestamp<this.detectionTimeout)return this.lastDetection.result;const a=t.getImageData(0,0,e,s);for(const h of this.templates){const r=this.matchTemplateOptimized(a,h,e,s);if(r&&r.confidence>this.threshold){const l={detected:!0,type:"image",name:h.name,position:r.position,size:r.size,confidence:r.confidence};return this.detectionCache.set(n,{timestamp:i,result:l}),this.lastDetection={timestamp:i,result:l},console.log(`✅ 检测到图片 "${h.name}"，匹配度: ${r.confidence.toFixed(3)}`),l}}this.lastDetection&&i-this.lastDetection.timestamp>this.detectionTimeout&&(this.lastDetection=null);const c={detected:!1};return this.detectionCache.set(n,{timestamp:i,result:c}),c}catch(i){return console.error("图片检测错误:",i),{detected:!1}}}matchTemplateOptimized(t,e,s,i){const n=e.width,o=e.height;if(n>s||o>i)return null;let a=null,c=0;const h=Math.max(3,Math.floor(Math.min(n,o)/20)),r=Math.min(80,Math.floor(Math.min(s,i)*.08)),l=r,d=r,m=s-n-r,w=i-o-r,p=100;let u=0;for(let g=d;g<=w&&u<p;g+=h)for(let f=l;f<=m&&u<p;f+=h){u++;const y=this.calculateSimilarityFast(t,e.imageData,f,g,s,0,0,n,n,o);if(y>c&&(c=y,a={position:{x:f,y:g},size:{width:n,height:o},confidence:y},y>.8))return a}return a}calculateSimilarityFast(t,e,s,i,n,o,a,c,h,r){let l=0,d=0;const m=Math.max(1,Math.floor(Math.min(h,r)/10));for(let p=0;p<r;p+=m)for(let u=0;u<h;u+=m){const g=((i+p)*n+(s+u))*4,f=((a+p)*c+(o+u))*4,y=Math.abs(t.data[g]-e.data[f]),I=Math.abs(t.data[g+1]-e.data[f+1]),x=Math.abs(t.data[g+2]-e.data[f+2]);l+=(y+I+x)/3,d++}if(d===0)return 0;const w=l/d;return Math.max(0,1-w/255)}matchTemplate(t,e,s,i){return this.matchTemplateOptimized(t,e,s,i)}calculateSimilarity(t,e,s,i,n,o,a,c,h,r){return this.calculateSimilarityFast(t,e,s,i,n,o,a,c,h,r)}detectSimple(t,e,s){try{const i=t.getImageData(0,0,e,s),n=this.findHighContrastRegions(i,e,s);for(const o of n)if(this.isImageLike(o,i,e,s))return{detected:!0,type:"simple",position:{x:o.x,y:o.y},size:{width:o.width,height:o.height},confidence:.5};return{detected:!1}}catch(i){return console.error("简化检测错误:",i),{detected:!1}}}findHighContrastRegions(t,e,s){const i=[];for(let a=0;a<s-50;a+=25)for(let c=0;c<e-50;c+=25){const h=this.calculateRegionContrast(t,c,a,50,e);h>30&&i.push({x:c,y:a,width:50,height:50,contrast:h})}return i.sort((a,c)=>c.contrast-a.contrast).slice(0,3)}calculateRegionContrast(t,e,s,i,n){let o=255,a=0;for(let c=0;c<i;c++)for(let h=0;h<i;h++){const r=((s+c)*n+(e+h))*4,l=(t.data[r]+t.data[r+1]+t.data[r+2])/3;o=Math.min(o,l),a=Math.max(a,l)}return a-o}isImageLike(t,e,s,i){return this.calculateEdgeDensity(e,t.x,t.y,t.width,t.height,s)>.1}calculateEdgeDensity(t,e,s,i,n,o){let a=0,c=0;for(let h=1;h<n-1;h++)for(let r=1;r<i-1;r++){const l=((s+h)*o+(e+r))*4,d=(t.data[l]+t.data[l+1]+t.data[l+2])/3,m=((s+h)*o+(e+r-1))*4,w=(t.data[m]+t.data[m+1]+t.data[m+2])/3;Math.abs(d-w)>20&&a++,c++}return c>0?a/c:0}dispose(){this.templates=[],this.detectionCache.clear(),this.lastDetection=null,console.log("图片追踪器资源已清理")}}console.log("AR应用开始加载...");const v={enableFastStart:!0,resourceTimeout:2e3,detectionInterval:200,simpleDetection:!0,delayTrackerInit:500};function F(){if(console.log("检查基本功能..."),document.readyState==="loading")return console.log("DOM还在加载中..."),!1;const S=document.getElementById("startAR"),t=document.getElementById("startScreen"),e=document.getElementById("arScreen"),s=document.getElementById("loadingScreen");return console.log("UI元素检查:",{startARBtn:!!S,startScreen:!!t,arScreen:!!e,loadingScreen:!!s}),!S||!t||!e||!s?(console.error("必要的UI元素未找到！"),!1):!0}class C{constructor(){console.log("初始化OptimizedARApp..."),this.isInitialized=!1,this.isTracking=!1,this.animation=null,this.imageTracker=null,this.detectionCanvas=null,this.detectionCtx=null,this.resourcesLoaded=!1,this.init()}init(){if(console.log("开始快速初始化..."),!F()){console.error("基本功能检查失败"),this.hideLoading(),this.showError("应用初始化失败：基本功能检查失败");return}try{this.initUI(),this.initEventListeners(),v.enableFastStart&&(this.isInitialized=!0,this.hideLoading(),this.showStartScreen(),console.log("快速启动完成，界面已显示"),this.loadResourcesInBackground())}catch(t){console.error("初始化过程中出错:",t),this.hideLoading(),this.showError("应用初始化失败: "+t.message)}}initUI(){console.log("初始化UI元素..."),this.startScreen=document.getElementById("startScreen"),this.arScreen=document.getElementById("arScreen"),this.loadingScreen=document.getElementById("loadingScreen"),this.startARBtn=document.getElementById("startAR"),this.backBtn=document.getElementById("backBtn"),this.captureBtn=document.getElementById("captureBtn"),this.status=document.getElementById("status"),this.video=document.getElementById("video"),this.canvas=document.getElementById("canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d")),this.detectionCanvas=document.createElement("canvas"),this.detectionCtx=this.detectionCanvas.getContext("2d"),console.log("UI元素初始化完成")}async loadResourcesInBackground(){console.log("后台加载资源...");try{setTimeout(async()=>{await this.initTrackersAsync()},v.delayTrackerInit)}catch(t){console.error("后台资源加载失败:",t)}}async initTrackersAsync(){try{console.log("开始异步初始化追踪器...");const[t,e]=await Promise.allSettled([this.createImageTracker(),this.createAnimation()]);t.status==="fulfilled"&&(this.imageTracker=t.value,console.log("图片追踪器初始化成功")),e.status==="fulfilled"&&(this.animation=e.value,console.log("动画组件初始化成功")),this.resourcesLoaded=!0,console.log("AR组件初始化完成")}catch(t){console.error("追踪器初始化失败:",t)}}async createImageTracker(){const t=new A;t.detectionInterval=v.detectionInterval,t.threshold=.15;try{await t.addTemplate("/images/marker.png","marker"),console.log("Marker加载成功")}catch{console.log("Marker加载失败，使用备用方案"),await this.addTestTemplate(t)}return t}async createAnimation(){const t=new k;console.log("创建动画组件...");try{await t.loadFrames(),console.log("PNG动画加载成功"),console.log("动画状态:",{isLoaded:t.isLoaded,frameCount:t.frameCount,framesLength:t.frames.length,fps:t.fps})}catch(e){console.log("PNG动画加载失败:",e.message)}return t}async addTestTemplate(t){try{const e=document.createElement("canvas"),s=e.getContext("2d");e.width=80,e.height=80,s.fillStyle="#FFFFFF",s.fillRect(0,0,80,80),s.strokeStyle="#000000",s.lineWidth=2,s.strokeRect(10,10,60,60),s.fillStyle="#000000",s.fillRect(25,25,30,30),e.toBlob(i=>{const n=URL.createObjectURL(i);t.addTemplate(n,"test-marker"),console.log("测试模板添加成功")})}catch(e){console.error("添加测试模板失败:",e)}}initEventListeners(){console.log("初始化事件监听器..."),this.startARBtn&&this.startARBtn.addEventListener("click",()=>this.startAR()),this.backBtn&&this.backBtn.addEventListener("click",()=>this.stopAR()),this.captureBtn&&this.captureBtn.addEventListener("click",()=>this.capturePhoto()),console.log("事件监听器初始化完成")}async startAR(){console.log("开始AR体验..."),console.log("当前状态:",{isInitialized:this.isInitialized,resourcesLoaded:this.resourcesLoaded,hasImageTracker:!!this.imageTracker,hasAnimation:!!this.animation}),this.isInitialized||console.log("应用未完全初始化，尝试继续启动...");try{if(this.showARScreen(),this.updateStatus("正在启动摄像头..."),!await this.requestCamera()){this.showError("无法启动摄像头，请检查权限设置");return}this.updateStatus("摄像头已启动，等待视频加载..."),await this.waitForVideoLoad(),this.imageTracker||(this.updateStatus("正在准备图像识别..."),await this.waitForTracker()),this.updateStatus("开始追踪marker..."),this.startTracking()}catch(t){console.error("启动AR失败:",t),this.showError("启动AR失败: "+t.message)}}async waitForTracker(){return new Promise(t=>{const e=()=>{this.imageTracker?t():setTimeout(e,100)};e()})}startTracking(){this.isTracking||(this.isTracking=!0,this.trackFrame(),console.log("开始追踪"))}stopTracking(){this.isTracking=!1,this.animation&&this.animation.stop(),console.log("停止追踪")}trackFrame(){if(!(!this.isTracking||!this.video||!this.canvas||!this.ctx))try{this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),this.detectMarker(),requestAnimationFrame(()=>this.trackFrame())}catch(t){console.error("追踪帧处理错误:",t),this.stopTracking()}}async detectMarker(){if(!this.imageTracker){console.log("图片追踪器未准备好，跳过检测");return}if(!this.ctx){console.log("Canvas上下文未准备好，跳过检测");return}try{const t=await this.imageTracker.detect(this.ctx,this.canvas.width,this.canvas.height);t&&t.detected?this.showAnimation(t):this.hideAnimation()}catch(t){console.error("检测marker错误:",t)}}showAnimation(t){if(!this.animation){console.log("动画组件不存在，跳过显示");return}if(!this.canvas){console.log("Canvas不存在，跳过显示");return}if(!t||!t.position||!t.size){console.log("检测结果数据不完整，跳过显示");return}try{const e={x:t.position.x+t.size.width/2,y:t.position.y-t.size.height*.8},s={width:Math.max(t.size.width*1.5,150),height:Math.max(t.size.height*1.5,150)};console.log("准备显示动画",{position:e,size:s,animationLoaded:this.animation.isLoaded,framesCount:this.animation.frames?this.animation.frames.length:0,frameCount:this.animation.frameCount,canvasSize:`${this.canvas.width}x${this.canvas.height}`}),this.animation.start(this.canvas,e,s),this.updateStatus("检测到marker，显示动画")}catch(e){console.error("显示动画错误:",e),this.updateStatus("动画显示失败: "+e.message)}}hideAnimation(){this.animation&&this.animation.stop()}async requestCamera(){try{const t=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"environment"}});return this.video.srcObject=t,this.video.play(),console.log("摄像头启动成功"),!0}catch(t){return console.error("摄像头启动失败:",t),!1}}waitForVideoLoad(){return new Promise((t,e)=>{const s=setTimeout(()=>{e(new Error("视频加载超时"))},5e3);this.video.onloadedmetadata=()=>{clearTimeout(s),this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,console.log("视频加载完成"),t()},this.video.onerror=i=>{clearTimeout(s),e(new Error("视频加载失败"))}})}stopAR(){console.log("停止AR体验..."),this.stopTracking(),this.video&&this.video.srcObject&&(this.video.srcObject.getTracks().forEach(e=>e.stop()),this.video.srcObject=null),this.showStartScreen(),this.updateStatus("AR体验已停止")}capturePhoto(){if(this.canvas)try{const t=document.createElement("canvas"),e=t.getContext("2d");t.width=this.canvas.width,t.height=this.canvas.height,e.drawImage(this.canvas,0,0);const s=t.toDataURL("image/png"),i=document.createElement("a");i.download=`ar-photo-${Date.now()}.png`,i.href=s,i.click(),this.updateStatus("照片已保存"),console.log("照片已保存")}catch(t){console.error("拍照失败:",t),this.updateStatus("拍照失败")}}showLoading(){this.loadingScreen&&(this.loadingScreen.style.display="flex"),this.startScreen&&(this.startScreen.style.display="none"),this.arScreen&&(this.arScreen.style.display="none")}hideLoading(){this.loadingScreen&&(this.loadingScreen.style.display="none")}showStartScreen(){this.startScreen&&(this.startScreen.style.display="flex"),this.arScreen&&(this.arScreen.style.display="none"),this.loadingScreen&&(this.loadingScreen.style.display="none")}showARScreen(){this.arScreen&&(this.arScreen.style.display="flex"),this.startScreen&&(this.startScreen.style.display="none"),this.loadingScreen&&(this.loadingScreen.style.display="none")}updateStatus(t){this.status&&(this.status.textContent=t),console.log("状态更新:",t)}showError(t){console.error("错误:",t),this.updateStatus("错误: "+t),setTimeout(()=>{this.updateStatus("")},3e3)}}function T(){if(console.log("开始初始化AR应用..."),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){alert("您的浏览器不支持摄像头功能，请使用现代浏览器");return}window.arApp=new C}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",T):T();
//# sourceMappingURL=main-CshxKk12.js.map
